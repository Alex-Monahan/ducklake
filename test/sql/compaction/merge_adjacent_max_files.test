# name: test/sql/compaction/merge_adjacent_max_files.test
# description: test ducklake merge adjacent files max_files options
# group: [compaction]

require ducklake

require parquet

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__

statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/merge_adjacent_max_files/')

statement ok
USE ducklake;

statement ok
CREATE TABLE example (key integer);

# Generate 20 files
loop i 0 20

statement ok
INSERT INTO example VALUES (${i});

statement ok
CALL ducklake_flush_inlined_data('ducklake')

endloop

query III
SELECT table_name, files_processed, files_created FROM ducklake_merge_adjacent_files('ducklake', 'example', max_compacted_files=>1)
----
example	20	1

# We create max one file, since we use the default size limits, one file should fit all
query I
SELECT max(data_file_id) = min(data_file_id) FROM __ducklake_metadata_ducklake.ducklake_data_file
----
true

statement ok
DROP TABLE example;

statement ok
CALL ducklake_expire_snapshots('ducklake', older_than => now());

statement ok
CALL ducklake.set_option('target_file_size', '1KB');

statement ok
CREATE TABLE example (key integer);

# Generate 20 files
loop i 0 20

statement ok
INSERT INTO example VALUES (${i});

statement ok
CALL ducklake_flush_inlined_data('ducklake')

endloop

query I
SELECT count(*) FROM __ducklake_metadata_ducklake.ducklake_data_file
----
20

statement error
CALL ducklake_merge_adjacent_files('ducklake', 'example', max_compacted_files=>-1);
----
Type INT32 with value -1 can't be cast

statement error
CALL ducklake_merge_adjacent_files('ducklake', 'example', max_compacted_files=>NULL);
----
The max_compacted_files option must be a non-null integer

statement error
CALL ducklake_merge_adjacent_files('ducklake', 'example', max_compacted_files=>0);
----
The max_compacted_files option must be greater than zero.

query I
SELECT count(*) FROM __ducklake_metadata_ducklake.ducklake_data_file
----
20

query I
SELECT count(*) FROM __ducklake_metadata_ducklake.ducklake_data_file
----
20

query II
SELECT table_name, files_created FROM ducklake_merge_adjacent_files('ducklake', 'example', max_compacted_files=>2) ORDER BY ALL
----
example	1
example	1

# We create two new files, and remove as many as necessary to create them
query I
SELECT count(*) < 20 FROM __ducklake_metadata_ducklake.ducklake_data_file
----
true

query II
SELECT table_name, files_created FROM ducklake_merge_adjacent_files('ducklake', 'example', max_compacted_files=>1)
----
example	1

# We create max one file - active file count decreased
query I
SELECT count(*) < 20 FROM __ducklake_metadata_ducklake.ducklake_data_file WHERE end_snapshot IS NULL
----
true

statement ok
SELECT table_name, files_processed, files_created FROM ducklake_merge_adjacent_files('ducklake', 'example', max_compacted_files=>1000) ORDER BY ALL

# We basically do max compaction, limiting the size set

# Keep merging until fully compacted
statement ok
SELECT table_name, files_processed, files_created FROM ducklake_merge_adjacent_files('ducklake', 'example', max_compacted_files=>1000)

statement ok
SELECT table_name, files_processed, files_created FROM ducklake_merge_adjacent_files('ducklake', 'example', max_compacted_files=>1000)

# Check data is still correct
query I
select count(*) FROM example;
----
20

# Test max_compacted_files with database-wide compaction (no table specified)
statement ok
DROP TABLE example;

statement ok
CALL ducklake_expire_snapshots('ducklake', older_than => now());

statement ok
CALL ducklake.set_option('target_file_size', '1KB');

statement ok
CREATE TABLE table1 (key integer);

statement ok
CREATE TABLE table2 (key integer);

# Generate 10 files per table
loop i 0 10

statement ok
INSERT INTO table1 VALUES (${i});

statement ok
INSERT INTO table2 VALUES (${i});

statement ok
CALL ducklake_flush_inlined_data('ducklake')

endloop

query I
SELECT count(*) FROM __ducklake_metadata_ducklake.ducklake_data_file
----
20

# Compact entire database with max_compacted_files=1 per table
# Each table should get at most 1 compaction operation
query II
SELECT table_name, files_created FROM ducklake_merge_adjacent_files('ducklake', max_compacted_files=>1) ORDER BY table_name
----
table1	1
table2	1

# Both tables got compacted (1 operation each)
query I
SELECT count(*) < 20 FROM __ducklake_metadata_ducklake.ducklake_data_file
----
true

# Check data is still correct
query I
SELECT (SELECT count(*) FROM table1) + (SELECT count(*) FROM table2);
----
20

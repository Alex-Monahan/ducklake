# name: test/sql/sorted_table/insert_sorted_expression.test
# description: test that INSERT operations sort data using expression-based sort keys
# group: [sorted_table]

require ducklake

require parquet

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__

statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/insert_sorted_expr')

# sort by expression: concat
statement ok
CREATE TABLE ducklake.test_concat(first_name VARCHAR, last_name VARCHAR)

statement ok
ALTER TABLE ducklake.test_concat SET SORTED BY (concat(last_name, ', ', first_name) ASC)

statement ok
INSERT INTO ducklake.test_concat VALUES ('John', 'Smith'), ('Alice', 'Brown'), ('Bob', 'Johnson')

query II
SELECT * FROM ducklake.test_concat
----
Alice	Brown
Bob	Johnson
John	Smith

# sort by expression: arithmetic
statement ok
CREATE TABLE ducklake.test_arith(a INTEGER, b INTEGER)

statement ok
ALTER TABLE ducklake.test_arith SET SORTED BY ((a + b) DESC)

statement ok
INSERT INTO ducklake.test_arith VALUES (1, 2), (5, 1), (2, 2), (3, 5)

query II
SELECT * FROM ducklake.test_arith
----
3	5
5	1
2	2
1	2

# sort by multiple expressions: primary sort on length(name), secondary on (a * b) DESC
statement ok
CREATE TABLE ducklake.test_multi_expr(a INTEGER, b INTEGER, name VARCHAR)

statement ok
ALTER TABLE ducklake.test_multi_expr SET SORTED BY (length(name) ASC, (a * b) DESC)

statement ok
INSERT INTO ducklake.test_multi_expr VALUES (3, 4, 'ab'), (2, 5, 'abc'), (1, 1, 'ab'), (5, 2, 'abc'), (7, 1, 'a')

# length('a')=1, length('ab')=2, length('abc')=3
# within length=2: (3*4)=12 > (1*1)=1
# within length=3: (2*5)=10 = (5*2)=10 (stable order)
query III
SELECT * FROM ducklake.test_multi_expr
----
7	1	a
3	4	ab
1	1	ab
2	5	abc
5	2	abc

# sort by complex nested expression: concat(substr(power(unique_id, unique_id)::varchar, 1, 1), name)
statement ok
CREATE TABLE ducklake.test_nested_expr(unique_id BIGINT, name VARCHAR)

statement ok
ALTER TABLE ducklake.test_nested_expr SET SORTED BY (concat(substr(power(unique_id, unique_id)::varchar, 1, 1), name) ASC NULLS LAST)

statement ok
INSERT INTO ducklake.test_nested_expr VALUES (1, 'one'), (2, 'two'), (3, 'three'), (4, 'four'), (5, 'five'), (6, 'six'), (7, 'seven'), (8, 'eight')

query III
SELECT *, concat(substr(power(unique_id, unique_id)::varchar, 1, 1), name) as sort_col 
FROM ducklake.test_nested_expr
----
8	eight	1eight
1	one	1one
4	four	2four
3	three	2three
5	five	3five
6	six	4six
2	two	4two
7	seven	8seven

